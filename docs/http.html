<!DOCTYPE html>

<html>
<head>
  <title>SERVER CLASS</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="Config.html">
                  Config.js
                </a>
              
                
                <a class="source" href="http.html">
                  http.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>),
    https = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>),
    url = <span class="hljs-built_in">require</span>(<span class="hljs-string">'url'</span>),
    path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>),
    fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>),
    querystring=<span class="hljs-built_in">require</span>(<span class="hljs-string">'querystring'</span>),
    Config = <span class="hljs-built_in">require</span>(<span class="hljs-string">`<span class="hljs-subst">${__dirname}</span>/Config.js`</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <h1 id="server-class">SERVER CLASS</h1>
<hr>

            </div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Server</span></span>{
    <span class="hljs-keyword">constructor</span>(userConfig){</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p><code>server.config</code> is where the servers configuration will reside.
It is a new instance of the <a href="./Config.html">Config class</a> which will be shallow merged with
the passed <code>userConfig</code> if one is passed upon construction of the Server class, or to the <code>server.deploy</code> method.</p>
<p><a href="https://github.com/RIAEvangelist/node-http-server#custom-configuration">Detailed info on the server.config or userConfig</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">this</span>.config=<span class="hljs-keyword">new</span> <span class="hljs-keyword">this</span>.Config(userConfig);
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><code>server.deploy</code> starts the server.
if a <code>userConfig</code> object is passed it will shallow merge/decorate it with a clean instantion of the <a href="./Config.html">Config class</a>
once the server is up and running it will call the <code>readyCallback</code></p>
<pre><code class="lang-javascript">
<span class="hljs-keyword">const</span> server=<span class="hljs-built_in">require</span>(<span class="hljs-string">'node-http-server'</span>);

server.deploy(
    {
        <span class="hljs-attr">port</span>:<span class="hljs-number">8000</span>,
        <span class="hljs-attr">root</span>:<span class="hljs-string">'~/myApp/'</span>
    },
    serverReady
);

server.deploy(
    {
        <span class="hljs-attr">port</span>:<span class="hljs-number">8888</span>,
        <span class="hljs-attr">root</span>:<span class="hljs-string">'~/myOtherApp/'</span>
    },
    serverReady
);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serverReady</span>(<span class="hljs-params">server</span>)</span>{
   <span class="hljs-built_in">console</span>.log( <span class="hljs-string">`Server on port <span class="hljs-subst">${server.config.port}</span> is now up`</span>);
}
</code></pre>
<p><a href="https://github.com/RIAEvangelist/node-http-server#examples">More Examples for deploying a node server</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    get deploy(){
      <span class="hljs-keyword">return</span> deploy;
    }</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>executed before any processing of request. If returns true response serving will be delayed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    onRawRequest(request,response,serve){

    }</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>executed just after request recieved allowing user to modify if needed. If returns true response serving will be delayed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    onRequest(request,response,serve){

    }</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>executed just before response sent allowing user to modify if needed. If returns true response serving will be delayed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    beforeServe(request,response,body,encoding,serve){

    }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>executed after each full response completely sent</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    afterServe(request){

    }

    get serve(){
      <span class="hljs-keyword">return</span> serve;
    }

    get serveFile(){
      <span class="hljs-keyword">return</span> serveFile;
    }

    get Config(){
      <span class="hljs-keyword">return</span> Config
    }

    get Server(){
      <span class="hljs-keyword">return</span> Server
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">deploy</span>(<span class="hljs-params">userConfig, readyCallback</span>)</span>{
    <span class="hljs-built_in">Object</span>.defineProperty(
        <span class="hljs-keyword">this</span>,
        <span class="hljs-string">'server'</span>,
        {
            <span class="hljs-attr">value</span>:http.createServer(
                requestRecieved.bind(<span class="hljs-keyword">this</span>)
            ),
            <span class="hljs-attr">writable</span>:<span class="hljs-literal">false</span>,
            <span class="hljs-attr">enumerable</span>:<span class="hljs-literal">true</span>
        }
    );

    <span class="hljs-keyword">if</span>(userConfig){
      <span class="hljs-built_in">Object</span>.assign(<span class="hljs-keyword">this</span>.config,userConfig);
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.https &amp;&amp; <span class="hljs-keyword">this</span>.config.https.privateKey &amp;&amp; <span class="hljs-keyword">this</span>.config.https.certificate){
        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.config.https.port){
            <span class="hljs-keyword">this</span>.config.https.port=<span class="hljs-number">443</span>;
        }
        <span class="hljs-keyword">this</span>.config.httpsOptions = {
            <span class="hljs-attr">key</span>: fs.readFileSync(<span class="hljs-keyword">this</span>.config.https.privateKey),
            <span class="hljs-attr">cert</span>: fs.readFileSync(<span class="hljs-keyword">this</span>.config.https.certificate),
            <span class="hljs-attr">passphrase</span>: <span class="hljs-keyword">this</span>.config.https.passphrase
        };

        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.https.ca){
            <span class="hljs-keyword">this</span>.config.httpsOptions.ca=fs.readFileSync(<span class="hljs-keyword">this</span>.config.https.ca);
        }

        <span class="hljs-built_in">Object</span>.defineProperty(
            <span class="hljs-keyword">this</span>,
            <span class="hljs-string">'secureServer'</span>,
            {
                <span class="hljs-attr">value</span>:https.createServer(
                    <span class="hljs-keyword">this</span>.config.httpsOptions,
                    requestRecieved.bind(<span class="hljs-keyword">this</span>)
                ),
                <span class="hljs-attr">writable</span>:<span class="hljs-literal">false</span>,
                <span class="hljs-attr">enumerable</span>:<span class="hljs-literal">true</span>
            }
        );
    }<span class="hljs-keyword">else</span>{
        <span class="hljs-keyword">this</span>.config.https={
            <span class="hljs-attr">only</span>:<span class="hljs-literal">false</span>
        };
    }

    <span class="hljs-keyword">this</span>.config.logID=<span class="hljs-string">`### <span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.domain}</span> server`</span>;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
        <span class="hljs-built_in">console</span>.log(
            <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> configured with ###\n\n`</span>,<span class="hljs-keyword">this</span>.config);
    }

    <span class="hljs-keyword">this</span>.server.timeout=<span class="hljs-keyword">this</span>.config.server.timeout;

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.config.https.only){
        <span class="hljs-keyword">this</span>.server.listen(
            <span class="hljs-keyword">this</span>.config.port,
            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> listening on port <span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.port}</span> ###\n\n`</span>);
                }
                <span class="hljs-keyword">if</span> (readyCallback){</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>The <code>readyCallback</code> is passed the full server instance
so that you may use the same callback to handle multiple
server instances in the same code instead of writing an inline
callbackâ€¦ think about it ;)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    readyCallback(<span class="hljs-keyword">this</span>);
                }
            }.bind(<span class="hljs-keyword">this</span>)
        );
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.httpsOptions){
        <span class="hljs-keyword">this</span>.secureServer.listen(
            <span class="hljs-keyword">this</span>.config.https.port,
            <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`HTTPS: <span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> listening on port <span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.https.port}</span> ###\n\n`</span>);
                }
                <span class="hljs-keyword">if</span> (readyCallback){</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>for example the same ready callback could handle both the
https and http servers with a simple test for the servers port</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    readyCallback(<span class="hljs-keyword">this</span>);
                }
            }.bind(<span class="hljs-keyword">this</span>)
        );
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setHeaders</span>(<span class="hljs-params">response,headers</span>)</span>{
    <span class="hljs-keyword">const</span> keys=<span class="hljs-built_in">Object</span>.keys(headers);
    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">const</span> i <span class="hljs-keyword">in</span> keys){
        response.setHeader(
            keys[i],
            headers[keys[i]]
        );
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serveFile</span>(<span class="hljs-params">filename,exists,request,response</span>) </span>{
    <span class="hljs-keyword">if</span>(!exists) {
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> 404 ###\n\n`</span>);
        }

        <span class="hljs-keyword">if</span>(!response){
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        response.statusCode=<span class="hljs-number">404</span>;
        setHeaders(response, <span class="hljs-keyword">this</span>.config.errors.headers);

        <span class="hljs-keyword">this</span>.serve(
            request,
            response,
            <span class="hljs-keyword">this</span>.config.errors[<span class="hljs-string">'404'</span>]
        );
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">const</span> contentType = path.extname(filename).slice(<span class="hljs-number">1</span>);

    <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.config.contentType[contentType]){
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> 415 ###\n\n`</span>);
        }

        response.statusCode=<span class="hljs-number">415</span>;
        setHeaders(response, <span class="hljs-keyword">this</span>.config.errors.headers);

        <span class="hljs-keyword">this</span>.serve(
            request,
            response,
            <span class="hljs-keyword">this</span>.config.errors[<span class="hljs-string">'415'</span>]
        );
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (
        fs.statSync(filename).isDirectory()
    ){
        filename+=<span class="hljs-string">`/<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.server.index}</span>`</span>;
    }

    <span class="hljs-keyword">if</span> (
        <span class="hljs-keyword">this</span>.config.restrictedType[contentType]
    ){
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> 403 ###\n\n`</span>);
        }

        response.statusCode=<span class="hljs-number">403</span>;
        setHeaders(response, <span class="hljs-keyword">this</span>.config.errors.headers);

        <span class="hljs-keyword">this</span>.serve(
            request,
            response,
            <span class="hljs-keyword">this</span>.config.errors[<span class="hljs-string">'403'</span>]
        );
        <span class="hljs-keyword">return</span>;
    }

    fs.readFile(
        filename,
        <span class="hljs-string">'binary'</span>,
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, file</span>) </span>{
            <span class="hljs-keyword">if</span>(err) {
                <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> 500 ###\n\n`</span>,err,<span class="hljs-string">'\n\n'</span>);
                }

                response.statusCode=<span class="hljs-number">500</span>;
                setHeaders(response, <span class="hljs-keyword">this</span>.config.errors.headers);

                <span class="hljs-keyword">this</span>.serve(
                    request,
                    response,
                    <span class="hljs-keyword">this</span>.config.errors[<span class="hljs-string">'500'</span>].replace(<span class="hljs-regexp">/\{\{err\}\}/g</span>,err)
                );
                <span class="hljs-keyword">return</span>;
            }

            response.setHeader(
                <span class="hljs-string">'Content-Type'</span>,
                <span class="hljs-keyword">this</span>.config.contentType[contentType]
            );

            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.server.noCache){
                response.setHeader(
                    <span class="hljs-string">'Cache-Control'</span>,
                    <span class="hljs-string">'no-cache, no-store, must-revalidate'</span>
                );
            }

            response.statusCode=<span class="hljs-number">200</span>;

            <span class="hljs-keyword">this</span>.serve(
                request,
                response,
                file,
                <span class="hljs-string">'binary'</span>
            );

            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> 200 ###\n\n`</span>);
            }

            <span class="hljs-keyword">return</span>;
        }.bind(<span class="hljs-keyword">this</span>)
    );
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">serve</span>(<span class="hljs-params">request,response,body,encoding</span>)</span>{
    <span class="hljs-keyword">if</span>(!response.statusCode){
        response.statusCode=<span class="hljs-number">200</span>;
    }

    <span class="hljs-keyword">if</span>(!response.getHeader(<span class="hljs-string">'Content-Type'</span>)){
        response.setHeader(
            <span class="hljs-string">'Content-Type'</span>,
            <span class="hljs-string">'text/plain'</span>
        );

        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> response content-type header not specified ###\n\nContent-Type set to: text/plain\n\n`</span>);
        }
    }

    <span class="hljs-keyword">if</span>(!encoding){
        encoding=<span class="hljs-string">'utf8'</span>;

        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> encoding not specified ###\nencoding set to:\n`</span>,encoding,<span class="hljs-string">'\n\n'</span>);
        }
    }

    <span class="hljs-keyword">const</span> refBody=<span class="hljs-keyword">new</span> RefString;
    <span class="hljs-keyword">const</span> refEncoding=<span class="hljs-keyword">new</span> RefString;

    refBody.value=body;
    refEncoding.value=encoding;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>return any value to force or specify delayed or manual serving</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(
        <span class="hljs-keyword">this</span>.beforeServe(
            request,
            response,
            refBody,
            refEncoding,
            completeServing.bind(<span class="hljs-keyword">this</span>)
        )
    ){
        <span class="hljs-keyword">return</span>;
    };

    completeServing.bind(<span class="hljs-keyword">this</span>)(request,response,refBody,encoding);

    <span class="hljs-keyword">return</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">completeServing</span>(<span class="hljs-params">request,response,refBody,refEncoding</span>)</span>{
    <span class="hljs-keyword">if</span>(!(refBody <span class="hljs-keyword">instanceof</span> RefString)){
        refBody=<span class="hljs-keyword">new</span> RefString(refBody);
    }

    <span class="hljs-keyword">if</span>(!(refEncoding <span class="hljs-keyword">instanceof</span> RefString)){
        refEncoding=<span class="hljs-keyword">new</span> RefString(refEncoding||<span class="hljs-string">'binary'</span>);
    }

    <span class="hljs-keyword">if</span>(response.finished){
        <span class="hljs-keyword">this</span>.afterServe(request);
        <span class="hljs-keyword">return</span>;
    }

    response.end(
        refBody.value,
        refEncoding.value,
        <span class="hljs-keyword">this</span>.afterServe.bind(<span class="hljs-keyword">this</span>,request)
    );
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">RefString</span>(<span class="hljs-params">value</span>)</span>{
    <span class="hljs-built_in">Object</span>.defineProperties(
        <span class="hljs-keyword">this</span>,
        {
            <span class="hljs-attr">value</span>:{
                <span class="hljs-attr">value</span>:value||<span class="hljs-string">''</span>,
                <span class="hljs-attr">enumerable</span>:<span class="hljs-literal">true</span>,
                <span class="hljs-attr">writable</span>:<span class="hljs-literal">true</span>
            }
        }
    );
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requestRecieved</span>(<span class="hljs-params">request,response</span>)</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.log){
        <span class="hljs-keyword">const</span> logData={
            <span class="hljs-attr">method</span>  : request.method,
            <span class="hljs-attr">url</span>     : request.url,
            <span class="hljs-attr">headers</span> : request.headers
        };

        <span class="hljs-keyword">this</span>.config.logFunction(
            logData
        );
    }

    <span class="hljs-keyword">let</span> uri = url.parse(request.url);
    uri.protocol=<span class="hljs-string">'http'</span>;
    uri.host=uri.hostname=request.headers.host;
    uri.port=<span class="hljs-number">80</span>;
    uri.query=querystring.parse(uri.query);

    <span class="hljs-keyword">if</span>(request.connection.encrypted){
        uri.protocol=<span class="hljs-string">'https'</span>;
        uri.port=<span class="hljs-number">443</span>;
    }

    (
        <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>{
            <span class="hljs-keyword">if</span>(!uri.host){
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">const</span> host=uri.host.split(<span class="hljs-string">':'</span>);

            <span class="hljs-keyword">if</span>(!host[<span class="hljs-number">1</span>]){
                <span class="hljs-keyword">return</span>;
            }
            uri.host=uri.hostname=host[<span class="hljs-number">0</span>];
            uri.port=host[<span class="hljs-number">1</span>];
        }
    )();

    <span class="hljs-keyword">for</span>(<span class="hljs-keyword">let</span> key <span class="hljs-keyword">in</span> uri){
        <span class="hljs-keyword">if</span>(uri[key]!==<span class="hljs-literal">null</span>){
            <span class="hljs-keyword">continue</span>;
        }
        uri[key]=<span class="hljs-string">''</span>;
    }

    request.uri=uri;</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>return any value to force delayed serving</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(
        <span class="hljs-keyword">this</span>.onRawRequest(
            request,
            response,
            completeServing.bind(<span class="hljs-keyword">this</span>)
        )
    ){
        <span class="hljs-keyword">return</span>;
    };

    uri=uri.pathname;

    <span class="hljs-keyword">if</span> (uri==<span class="hljs-string">'/'</span>){
        uri=<span class="hljs-string">`/<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.server.index}</span>`</span>;
    }

    <span class="hljs-keyword">let</span> hostname= [];

    <span class="hljs-keyword">if</span> (request.headers.host !== <span class="hljs-literal">undefined</span>){
        hostname = request.headers.host.split(<span class="hljs-string">':'</span>);
    }

    <span class="hljs-keyword">let</span> root = <span class="hljs-keyword">this</span>.config.root;

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> REQUEST ###\n\n`</span>,
            request.headers,<span class="hljs-string">'\n'</span>,
            uri,<span class="hljs-string">'\n\n'</span>,
            hostname,<span class="hljs-string">'\n\n'</span>
        );
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.domain!=<span class="hljs-string">'0.0.0.0'</span> &amp;&amp; hostname.length &gt; <span class="hljs-number">0</span> &amp;&amp; hostname[<span class="hljs-number">0</span>]!=<span class="hljs-keyword">this</span>.config.domain){
        <span class="hljs-keyword">if</span>(!<span class="hljs-keyword">this</span>.config.domains[hostname[<span class="hljs-number">0</span>]]){
            <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> INVALID HOST ###\n\n`</span>);
            }
            <span class="hljs-keyword">this</span>.serveFile(hostname[<span class="hljs-number">0</span>],<span class="hljs-literal">false</span>,response);
            <span class="hljs-keyword">return</span>;
        }
        root=<span class="hljs-keyword">this</span>.config.domains[hostname[<span class="hljs-number">0</span>]];
    }


    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.config.verbose){
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-keyword">this</span>.config.logID}</span> USING ROOT : <span class="hljs-subst">${root}</span>###\n\n`</span>);
    }

    <span class="hljs-keyword">if</span>(uri.slice(<span class="hljs-number">-1</span>)==<span class="hljs-string">'/'</span>){
        uri+=<span class="hljs-keyword">this</span>.config.server.index;
    }

    request.url=uri;
    request.serverRoot=root;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>return any value to force or specify delayed or manual serving</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span>(
        <span class="hljs-keyword">this</span>.onRequest(
            request,
            response,
            completeServing.bind(<span class="hljs-keyword">this</span>)
        )
    ){
        <span class="hljs-keyword">return</span>;
    };

    <span class="hljs-keyword">const</span> filename = path.join(
        request.serverRoot,
        request.url
    );

    fs.exists(
        filename,
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fileExists</span>(<span class="hljs-params">exists</span>)</span>{
            <span class="hljs-keyword">this</span>.serveFile(filename,exists,request,response);
        }.bind(<span class="hljs-keyword">this</span>)
    );
}

<span class="hljs-built_in">module</span>.exports=<span class="hljs-keyword">new</span> Server;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
